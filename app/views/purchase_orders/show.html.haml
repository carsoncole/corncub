.row
  .col-md-12
    .card
      .card-block
        .card-title
          %h2
            Take Orders Purchase Order

          %h3
            %span.tag.tag-info= @purchase_order.status.capitalize 
        %table.table
          %thead
            %tr
              %th Product
              %th Quantity
              %th Unit Inventory
              %th Net Quantity
              %th Price
              %th Value
          %tbody
            - total_value = 0
            - @products.each do |product|
              - quantity = TakeOrderPurchaseOrder.joins(take_orders: [:take_order_line_items]).where("purchase_orders.id = ? AND take_order_line_items.product_id = ?", @purchase_order.id, product.id).sum("take_order_line_items.quantity")
              - if quantity != 0
                %tr
                  %td= product.name
                  %td= quantity
                  %td
                    - unit_inventory = @unit.inventory(product)
                    - unit_inventory += quantity + @unit.stocks.where(product_id: product.id).take_orders.sum(:quantity)
                    = unit_inventory
                  %td
                    - net_quantity = quantity - unit_inventory
                    = net_quantity
                  %td= number_to_currency(product.retail_price)
                  %td
                    - value = product.retail_price * net_quantity
                    - total_value += value
                    = number_to_currency( value )
            %tr
              %td
              %td
              %td
              %td
              %td
              %td= number_to_currency( total_value )

        - if @purchase_order.status == 'open'
          = button_to 'Ordered', purchase_order_path(@purchase_order, ordered: true), method: :patch, class: 'btn btn-danger'




.row
  .col-md-12
    .card
      .card-block
        .card-title
          %h3 Take Orders
        %table.table
          %thead
            %tr
              %th Scout
              %th 
              %td
              %td Envelope #
              %td Value
              %td Added
          - total_value = 0
          - @take_orders.each do |to|
            %tr
              %td= to.scout.name
              %td
                = link_to take_order_path(to) do
                  %i.fa.fa-folder-open.fa-lg
              %td= to.products_and_quantities
              %td= link_to to.envelope_id, envelope_path(to.envelope_id)
              %td
                - total_value += to.value_without_pack_donations
                = number_to_currency(to.value_without_pack_donations)
              %td= to.updated_at

          %tr
            %td
            %td
            %td= number_to_currency(total_value)
            %td
